generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserType {
  EMPLOYEE
  CUSTOMER
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   // Manual Unique Index (Partial)
  password  String
  fullName  String
  email     String?
  phone     String?
  role      String   @default("USER") // ADMIN, SALE, USER...
  type      UserType @default(EMPLOYEE)
  isActive  Boolean  @default(true)

  // Customer specific fields
  customerCode String? // Manual Unique Index (Partial)
  address      String?
  
  // Relations
  saleId       Int?
  sale         User?   @relation("SaleCustomers", fields: [saleId], references: [id])
  customers    User[]  @relation("SaleCustomers")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions        Transaction[] @relation("CustomerTransactions")
  createdTransactions Transaction[] @relation("CreatedTransactions")
  declarations        Declaration[] @relation("CustomerDeclarations")
  productCodes        ProductCode[] @relation("CustomerProductCodes")


  deletedAt DateTime? // Soft Delete

  @@map("users")
}

enum CostType {
  SHIP_NOI_DIA          // Ship nội địa
  PHI_NANG_HANG         // Phí nâng hàng
  PHI_HA_HANG           // Phí hạ hàng
  PHI_KEO_HANG          // Phí kéo hàng
  PHI_GIA_CO            // Phí gia cố
  PHI_DONG_GO           // Phí đóng gỗ
  PHI_KIEM_DEM          // Phí kiểm đếm
  PHI_LUU_KHO           // Phí lưu kho
  PHI_CAN               // Phí cân
  PHI_KIEM_TRA_CHAT_LUONG // Phí kiểm tra chất lượng
  PHI_TU_CONG_BO        // Phí tự công bố
  PHI_XU_LY_HAI_QUAN    // Phí xử lý hải quan
  PHI_THUONG_KIEM       // Phí thương kiểm
  PHI_KHAC              // Phí khác
}

enum Currency {
  YUAN
  VND
}

enum CostCalculationMethod {
  AUTO          // Tự động
  BY_WEIGHT     // Theo cân
  BY_VOLUME     // Theo khối
}

enum ProductCodeStatus {
  NHAP_KHO_TQ
  CHO_XEP_XE
  DA_XEP_XE
  KIEM_HOA
  CHO_THONG_QUAN_VN
  NHAP_KHO_VN
  XUAT_THIEU
  XUAT_DU
}

enum WarehouseStatus {
  AVAILABLE
  UNAVAILABLE
}

model Warehouse {
  id        Int             @id @default(autoincrement())
  name      String
  status    WarehouseStatus @default(AVAILABLE)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  deletedAt DateTime?       // Soft Delete

  productCodes ProductCode[]

  @@map("warehouses")
}

enum CategoryStatus {
  AVAILABLE
  UNAVAILABLE
}

model Category {
  id        Int            @id @default(autoincrement())
  name      String
  status    CategoryStatus @default(AVAILABLE)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  deletedAt DateTime?      // Soft Delete

  productCodes ProductCode[]

  @@map("categories")
}

enum TransactionStatus {
  SUCCESS
  CANCELLED
}

model Transaction {
  id          Int               @id @default(autoincrement())
  amount      Decimal           @db.Decimal(15, 0)
  content     String?
  status      TransactionStatus @default(SUCCESS)
  
  // Relations
  customerId  Int
  customer    User              @relation("CustomerTransactions", fields: [customerId], references: [id])
  
  createdById Int
  creator     User              @relation("CreatedTransactions", fields: [createdById], references: [id])

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@map("transactions")
}

model Declaration {
  id                   Int       @id @default(autoincrement())
  
  // Relations
  customerId           Int
  customer             User      @relation("CustomerDeclarations", fields: [customerId], references: [id])
  
  // 1. [A] Ngày nhập kho
  entryDate            DateTime? // DATETIME

  // 2. [B] Mã khách hàng (Store selected value or code)
  customerCodeInput    String?   // SELECTION BOX

  // 3. [C] Tên mặt hàng
  productName          String?   // STRING

  // 4. [D] Mã đơn hàng
  orderCode            String?   // STRING

  // 5. [E] Số Kiện
  packageCount         Int?      // NUMBER

  // 6. [F] Trọng lượng (Kg)
  weight               Decimal?  @db.Decimal(15, 2) // NUMBER

  // 7. [G] Khối lượng (m3)
  volume               Decimal?  @db.Decimal(15, 3) // NUMBER

  // 8. [H] Nguồn cung cấp thông tin
  infoSource           String?   // SELECTION BOX

  // 9. [I] Phí nội địa (RMB)
  domesticFeeRMB       Decimal?  @db.Decimal(15, 2) // NUMBER

  // 10. [J] Phí kéo hàng (RMB)
  haulingFeeRMB        Decimal?  @db.Decimal(15, 2) // NUMBER

  // 11. [K] Phí dỡ hàng (RMB)
  unloadingFeeRMB      Decimal?  @db.Decimal(15, 2) // NUMBER

  // 12. [L] Đơn giá cước vận chuyển TQ_HN
  transportRate        Decimal?  @db.Decimal(15, 2) // NUMBER

  // 14. [N] Tổng cước vận chuyển TQ_HN tạm tính
  totalTransportFeeEstimate Decimal? @db.Decimal(15, 2) // FORMULA

  // 15. [O] Ghi chú
  note                 String?   // STRING

  // 16. [P] Ảnh hàng hóa
  productImage         String?   // STRING (URL?)

  // 18. [R] Số Lượng sản phẩm
  productQuantity      Int?      // NUMBER

  // 19. [S] Quy cách
  specification        String?   // STRING

  // 20. [T] Mô Tả sản phẩm
  productDescription   String?   // STRING

  // 21. [U] Nhãn Hiệu
  brand                String?   // STRING

  // 22. [V] Nhu cầu khai báo
  declarationNeed      String?   // STRING

  // 23. [W] Chính sách khai báo
  declarationPolicy    String?   // STRING

  // 24. [X] Số lượng khai báo (Input 1)
  declarationQuantity  String?   // STRING

  // 25. [Y] Giá xuất hoá đơn
  invoicePrice         String?   // STRING

  // 26. [Z] THÔNG TIN CẦN BỔ SUNG
  additionalInfo       String?   // STRING

  // 27. [AA] Tên khai báo
  declarationName      String?   // STRING

  // 28. [AB] Số lượng khai báo (Input 2 - ambiguous in Excel)
  declarationQuantityDeclared String? // STRING

  // 29. [AC] Đơn vị tính
  unit                 String?   // STRING

  // 30. [AD] Giá khai báo
  declarationPrice     String?   // STRING

  // 31. [AE] Trị giá
  value                String?   // STRING

  // 32. [AF] số kiện (Declared)
  packageCountDeclared String?   // STRING

  // 33. [AG] net weight
  netWeight            String?   // STRING

  // 34. [AH] Gross weight
  grossWeight          String?   // STRING

  // 35. [AI] CBM (Declared)
  cbm                  String?   // STRING

  // 36. [AJ] HS CODE
  hsCode               String?   // STRING

  // 37. [AK] % thuế VAT
  vatPercent           String?   // STRING

  // 38. [AL] Thuế VAT phải nộp
  vatAmount            String?   // STRING

  // 39. [AM] %Thuế NK
  importTaxPercent     String?   // STRING

  // 40. [AN] Thuế NK usd
  importTaxUSD         String?   // STRING

  // 41. [AO] Thuế NK phải nộp VNĐ
  importTaxVND         String?   // STRING

  // 42. [AP] TỶ GIÁ HẢI QUAN
  customsExchangeRate  String?   // STRING

  // 43. [AQ] Phí ktcl
  qualityControlFee    String?   // STRING

  // 44. [AR] Xác nhận của PKT
  accountingConfirmation String? // STRING

  // History Tracking


  // System fields
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  deletedAt            DateTime? // Soft Delete

  productCodes         ProductCode[]

  @@map("declarations")
}

model ProductCode {
  id                    Int       @id @default(autoincrement())
  
  // Relations
  customerId            Int
  customer              User      @relation("CustomerProductCodes", fields: [customerId], references: [id])
  
  partnerName           String    // Tên đối tác
  
  warehouseId           Int
  warehouse             Warehouse @relation(fields: [warehouseId], references: [id])
  
  categoryId            Int
  category              Category  @relation(fields: [categoryId], references: [id])
  
  productName           String    // Tên sản phẩm
  exchangeRate          Decimal   @db.Decimal(15, 4) // Tỷ giá
  
  declarationId         Int?
  declaration           Declaration? @relation(fields: [declarationId], references: [id])
  
  notes                 String?   // Ghi chú
  
  // Trạng thái
  status                ProductCodeStatus @default(NHAP_KHO_TQ) // Trạng thái mã hàng
  
  // Thông tin chi phí & thuế
  separateTax           Boolean   @default(false) // Tách thuế
  originalWeightPrice   Decimal   @db.Decimal(15, 2) // Giá cân gốc
  originalVolumePrice   Decimal   @db.Decimal(15, 2) // Giá khối gốc
  serviceFee            Decimal   @db.Decimal(15, 2) // Phí dịch vụ
  importTax             Decimal?  @db.Decimal(15, 0) // Thuế nhập khẩu (VND) - nếu tách thuế
  vat                   Decimal?  @db.Decimal(15, 0) // Thuế VAT (VND) - nếu tách thuế
  totalAmount           Decimal   @db.Decimal(15, 2) // Thành tiền
  incidentalFee         Decimal   @db.Decimal(15, 2) @default(0) // Phí phát sinh
  incidentalNotes       String?   // Ghi chú phát sinh
  profit                Decimal   @db.Decimal(15, 2) @default(0) // Lợi nhuận
  
  // Thông số sản phẩm
  totalWeight           Decimal   @db.Decimal(15, 2) // Tổng cân
  totalVolume           Decimal   @db.Decimal(15, 3) // Tổng khối
  totalPackages         Int       // Tổng kiện
  
  // Thông tin giá cước
  costCalculationMethod CostCalculationMethod @default(AUTO) // Cách tính chi phí
  weightPrice           Decimal   @db.Decimal(15, 2) // Giá cân
  volumePrice           Decimal   @db.Decimal(15, 2) // Giá khối
  
  // Images
  images                String[]  // Mảng đường dẫn ảnh
  
  // Relations to sub-tables
  warehouseCosts        WarehouseCost[]
  packageDetails        PackageDetail[]
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  deletedAt             DateTime? // Soft Delete

  @@map("product_codes")
}

model WarehouseCost {
  id                Int         @id @default(autoincrement())
  
  productCodeId     Int
  productCode       ProductCode @relation(fields: [productCodeId], references: [id], onDelete: Cascade)
  
  costType          CostType    // Tên chi phí
  currency          Currency    // Tiền tệ
  originalCost      Decimal     @db.Decimal(15, 2) // Chi phí gốc
  otherFee          Decimal     @db.Decimal(15, 2) @default(0) // Tiền thu khác
  notes             String?     // Ghi chú
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@map("warehouse_costs")
}

model PackageDetail {
  id                Int         @id @default(autoincrement())
  
  productCodeId     Int
  productCode       ProductCode @relation(fields: [productCodeId], references: [id], onDelete: Cascade)
  
  trackingCode      String      // Mã vận đơn
  length            Decimal     @db.Decimal(10, 2) // Dài (cm)
  width             Decimal     @db.Decimal(10, 2) // Rộng (cm)
  height            Decimal     @db.Decimal(10, 2) // Cao (cm)
  totalWeight       Decimal     @db.Decimal(15, 2) // Tổng cân (kg)
  totalPackages     Int         // Tổng kiện
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@map("package_details")
}


