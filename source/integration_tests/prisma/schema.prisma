generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserType {
  EMPLOYEE
  CUSTOMER
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   // Manual Unique Index (Partial)
  password  String
  fullName  String
  email     String?
  phone     String?
  role      String   @default("USER") // ADMIN, SALE, USER...
  type      UserType @default(EMPLOYEE)
  isActive  Boolean  @default(true)

  // Customer specific fields
  customerCode String? // Manual Unique Index (Partial)
  address      String?
  
  // Relations
  saleId       Int?
  sale         User?   @relation("SaleCustomers", fields: [saleId], references: [id])
  customers    User[]  @relation("SaleCustomers")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions        Transaction[] @relation("CustomerTransactions")
  createdTransactions Transaction[] @relation("CreatedTransactions")
  productCodes        ProductCode[] @relation("CustomerProductCodes")
  employeeProductCodes ProductCode[] @relation("EmployeeProductCodes")
  notifications       Notification[] @relation("UserNotifications")

  deletedAt DateTime? // Soft Delete

  @@map("users")
}

enum CostType {
  SHIP_NOI_DIA          // Ship nội địa
  PHI_NANG_HANG         // Phí nâng hàng
  PHI_HA_HANG           // Phí hạ hàng
  PHI_KEO_HANG          // Phí kéo hàng
  PHI_GIA_CO            // Phí gia cố
  PHI_DONG_GO           // Phí đóng gỗ
  PHI_KIEM_DEM          // Phí kiểm đếm
  PHI_LUU_KHO           // Phí lưu kho
  PHI_CAN               // Phí cân
  PHI_KIEM_TRA_CHAT_LUONG // Phí kiểm tra chất lượng
  PHI_TU_CONG_BO        // Phí tự công bố
  PHI_XU_LY_HAI_QUAN    // Phí xử lý hải quan
  PHI_THUONG_KIEM       // Phí thương kiểm
  PHI_KHAC              // Phí khác
}

enum Currency {
  YUAN
  VND
}

enum CostCalculationMethod {
  AUTO          // Tự động
  BY_WEIGHT     // Theo cân
  BY_VOLUME     // Theo khối
}

enum ProductCodeStatus {
  NHAP_KHO_TQ
  CHO_XEP_XE
  DA_XEP_XE
  KIEM_HOA
  CHO_THONG_QUAN_VN
  NHAP_KHO_VN
  XUAT_THIEU
  XUAT_DU
}

enum WarehouseStatus {
  AVAILABLE
  UNAVAILABLE
}

model Warehouse {
  id        Int             @id @default(autoincrement())
  name      String
  status    WarehouseStatus @default(AVAILABLE)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  deletedAt DateTime?       // Soft Delete

  productCodes ProductCode[]

  @@map("warehouses")
}

enum CategoryStatus {
  AVAILABLE
  UNAVAILABLE
}

model Category {
  id        Int            @id @default(autoincrement())
  name      String
  status    CategoryStatus @default(AVAILABLE)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  deletedAt DateTime?      // Soft Delete

  productCodes ProductCode[]

  @@map("categories")
}

model MerchandiseCondition {
  id              Int                     @id @default(autoincrement())
  name_vi         String
  name_zh         String?
  canLoadVehicle  Boolean                 @default(false)
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  deletedAt       DateTime?               // Soft Delete

  productCodes    ProductCode[]

  @@map("merchandise_conditions")
}

enum TransactionStatus {
  SUCCESS
  CANCELLED
}

model Transaction {
  id          Int               @id @default(autoincrement())
  amount      Decimal           @db.Decimal(15, 0)
  content     String?
  status      TransactionStatus @default(SUCCESS)
  
  // Relations
  customerId  Int
  customer    User              @relation("CustomerTransactions", fields: [customerId], references: [id])
  
  createdById Int
  creator     User              @relation("CreatedTransactions", fields: [createdById], references: [id])

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@map("transactions")
}

model Declaration {
  id                   Int       @id @default(autoincrement())
  
  // Relations
  productCodeId        Int?
  productCode          ProductCode? @relation(fields: [productCodeId], references: [id])
  
  productItemId        Int?      @unique
  productItem          ProductItem? @relation(fields: [productItemId], references: [id], onDelete: Cascade)

  // Fields
  images               String?   @db.Text      // Ảnh hàng hóa (JSON array, tối đa 3)
  mainStamp            String?   @db.Text      // Tem chính
  subStamp             String?   @db.Text      // Tem phụ
  productQuantity      Int?                    // Số lượng sản phẩm
  specification        String?                 // Quy cách
  productDescription   String?   @db.Text      // Mô tả sản phẩm
  brand                String?                 // Nhãn hiệu
  sellerTaxCode        String?                 // Mã số thuế đơn vị bán hàng
  sellerCompanyName    String?                 // Tên công ty bán hàng
  declarationNeed      String?                 // Nhu cầu khai báo
  declarationQuantity  Int?                    // Số lượng khai báo
  invoicePriceBeforeVat Int?                   // Giá xuất hóa đơn (trước VAT) - VND
  totalLotValueBeforeVat Int?                  // Tổng giá trị lô hàng (trước VAT) - VND - Auto Calculated
  importTax            Decimal?  @db.Decimal(5, 2) // Thuế nhập khẩu (%)
  vatTax               Decimal?  @db.Decimal(5, 2) // Thuế VAT (%)
  importTaxPayable     Int?                    // Thuế nhập khẩu phải nộp - VND - Auto Calculated
  vatTaxPayable        Int?                    // Thuế VAT phải nộp - VND - Auto Calculated
  payableFee           Int?                    // Phí phải nộp - VND
  notes                String?   @db.Text      // Ghi chú
  entrustmentFee       Int?                    // Phí ủy thác - VND
  importCostToCustomer Int?                    // Chi phí nhập khẩu hàng hóa đến tay khách hàng - VND - Auto Calculated

  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  deletedAt            DateTime? // Soft Delete

  @@map("declarations")
}

model ProductCode {
  id                    Int       @id @default(autoincrement())
  
  // Relations
  employeeId            Int?
  employee              User?     @relation("EmployeeProductCodes", fields: [employeeId], references: [id])

  customerId            Int?
  customer              User?     @relation("CustomerProductCodes", fields: [customerId], references: [id])
  
  merchandiseConditionId Int?
  merchandiseCondition   MerchandiseCondition? @relation(fields: [merchandiseConditionId], references: [id])

  // Legacy/System relations
  warehouseId           Int?
  warehouse             Warehouse? @relation(fields: [warehouseId], references: [id])
  
  categoryId            Int?
  category              Category?  @relation(fields: [categoryId], references: [id])
  
  manifestId            Int?
  manifest              Manifest?    @relation(fields: [manifestId], references: [id])

  declarations          Declaration[]

  // MASTER FIELDS
  entryDate             DateTime? // Ngày nhập kho
  orderCode             String?   // Mã đơn hàng
  totalWeight           Int?      // Tổng trọng lượng (kg)
  totalVolume           Decimal?  @db.Decimal(15, 3) // Tổng khối lượng (m3)
  infoSource            String?   // Nguồn cung cấp thông tin (Kg.m3)
  totalTransportFeeEstimate Decimal? @db.Decimal(15, 2) // Tổng cước vận chuyển TQ_HN tạm tính
  exchangeRate          Decimal?  @db.Decimal(15, 4) // Tỷ giá (VND/RMB)
  
  // Relations to Details
  items                 ProductItem[]
  warehouseCosts        WarehouseCost[]
  packageDetails        PackageDetail[]
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  deletedAt             DateTime? // Soft Delete

  @@map("product_codes")
}

model ProductItem {
  id                Int         @id @default(autoincrement())
  
  productCodeId     Int
  productCode       ProductCode @relation(fields: [productCodeId], references: [id], onDelete: Cascade)
  
  productName       String?     // Tên mặt hàng
  packageCount      Int?        // Số kiện
  packageUnit       String?     // Đơn vị kiện (Selection box)
  weight            Int?        // Trọng lượng (kg)
  volume            Decimal?    @db.Decimal(15, 3) // Khối lượng (m3)
  volumeFee         Int?        // Đơn giá cước TQ_HN (khối)
  weightFee         Int?        // Đơn giá cước TQ_HN (cân)
  domesticFeeTQ     Decimal?    @db.Decimal(15, 2) // Phí nội địa (RMB)
  haulingFeeTQ      Decimal?    @db.Decimal(15, 2) // Phí kéo hàng (RMB)
  unloadingFeeRMB   Decimal?    @db.Decimal(15, 2) // Phí dỡ hàng (RMB)
  itemTransportFeeEstimate Decimal? @db.Decimal(15, 2) // Cước TQ_HN tạm tính (VND)
  notes             String?     @db.Text // Ghi chú
  
  declaration       Declaration?

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  deletedAt         DateTime?   // Soft Delete

  @@map("product_items")
}

model Manifest {
  id          Int           @id @default(autoincrement())
  name        String        // Tên chuyến (VD: Chuyến ngày 2/2/2026)
  date        DateTime      @default(now()) // Ngày xếp xe
  status      String        @default("OPEN") // OPEN, CLOSED, SHIPPED
  note        String?       // Ghi chú

  productCodes ProductCode[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  deletedAt   DateTime?     // Soft Delete

  @@map("manifests")
}

model WarehouseCost {
  id                Int         @id @default(autoincrement())
  
  productCodeId     Int
  productCode       ProductCode @relation(fields: [productCodeId], references: [id], onDelete: Cascade)
  
  costType          CostType    // Tên chi phí
  currency          Currency    // Tiền tệ
  originalCost      Decimal     @db.Decimal(15, 2) // Chi phí gốc
  otherFee          Decimal     @db.Decimal(15, 2) @default(0) // Tiền thu khác
  notes             String?     // Ghi chú
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@map("warehouse_costs")
}

model PackageDetail {
  id                Int         @id @default(autoincrement())
  
  productCodeId     Int
  productCode       ProductCode @relation(fields: [productCodeId], references: [id], onDelete: Cascade)
  
  trackingCode      String      // Mã vận đơn
  length            Decimal     @db.Decimal(10, 2) // Dài (cm)
  width             Decimal     @db.Decimal(10, 2) // Rộng (cm)
  height            Decimal     @db.Decimal(10, 2) // Cao (cm)
  totalWeight       Decimal     @db.Decimal(15, 2) // Tổng cân (kg)
  totalPackages     Int         // Tổng kiện
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@map("package_details")
}

model Notification {
  id          Int      @id @default(autoincrement())
  userId      Int      // Recipient
  user        User     @relation("UserNotifications", fields: [userId], references: [id])
  content     String
  isRead      Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("notifications")
}

model ShortDeclaration {
  id              Int       @id @default(autoincrement())
  
  // 9 trường thông tin chính
  productName     String?   @db.Text
  hsCode          String?
  origin          String?
  unit1           String?
  unit2           String?
  importTaxCode   String?
  importTaxRate   Decimal?  @db.Decimal(5, 2)
  vatTaxCode      String?
  vatTaxRate      Decimal?  @db.Decimal(5, 2)
  
  // Hash field for existing check
  hash            String?   @db.VarChar(255)
  
  // System fields
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime? // Soft Delete

  @@index([hash])
  @@map("short_declarations")
}


